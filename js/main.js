"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),Object.defineProperty(a,"prototype",{writable:!1}),a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function createContents(){var a={},b=document.querySelector(".article");if(b){var c=b.querySelectorAll("h2, h3");if(0<c.length){var d=0,e=0;c.forEach(function(b){var c="",f=b.nodeName,g=b.innerText;"H2"===f?(e=0,d+=1,a[d]={name:g,substeps:{}},c=d):(e+=1,c="".concat(d,".").concat(e),a[d].substeps[c]={name:g}),b.setAttribute("id",c),b.setAttribute("data-step-id",c)})}return a}return null}function init(){var a=createContents();a&&new Contents(a)}var Contents=function(){function a(b,c){_classCallCheck(this,a),_defineProperty(this,"_initTimeOut",null),_defineProperty(this,"_steps",{}),_defineProperty(this,"_currentStep",null),_defineProperty(this,"_lastSubstepId",null),_defineProperty(this,"_mobileBlockHtml","<div class=\"post-contents__mobile-bar\"><div class=\"post-contents__mobile-title\">\u041D\u0430\u0432\u0438\u0433\u0430\u0446\u0438\u044F \u043F\u043E \u0441\u0442\u0430\u0442\u044C\u0435</div><div class=\"post-contents__mobile-active-step\"></div><span class=\"post-contents__mobile-bar-icon\"><svg width=\"12\" height=\"12\" viewBox=\"0 0 12 12\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M1.22704 3.96983C1.36768 3.82923 1.55841 3.75024 1.75729 3.75024C1.95616 3.75024 2.14689 3.82923 2.28754 3.96983L6.00004 7.68233L9.71254 3.96983C9.85399 3.83322 10.0434 3.75762 10.2401 3.75933C10.4367 3.76104 10.6248 3.83991 10.7639 3.97897C10.903 4.11803 10.9818 4.30614 10.9835 4.50278C10.9853 4.69943 10.9097 4.88888 10.773 5.03033L6.53029 9.27308C6.38964 9.41369 6.19891 9.49267 6.00004 9.49267C5.80116 9.49267 5.61043 9.41369 5.46979 9.27308L1.22704 5.03033C1.08643 4.88969 1.00745 4.69896 1.00745 4.50008C1.00745 4.30121 1.08643 4.11048 1.22704 3.96983Z\" fill=\"currentColor\"/></svg></span><span class=\"post-contents__progress post-contents__progress_mobile\"><span class=\"post-contents__progress-bar\"></span></span></div>"),this.contentsObj=b,this.contentsBlock=c||this.createContentsBlock(b),this.initSteps(),this.toggleItemsState(),this.initMobileBlock(),this.initEventListeners()}return _createClass(a,[{key:"initEventListeners",value:function(){var a=this;a.contentsBlock.addEventListener("click",function(b){var c=b.target;if(c.closest(".post-contents__item-name")){var d=c.closest(".post-contents__item"),e=d.dataset.contentsStepId,f=document.querySelector("[data-step-id=\"".concat(e,"\"]"));if(f){var g=f.getBoundingClientRect().top;a.contentsBlock.classList.contains("post-contents_fixed")&&(g-=55),window.scrollBy({top:g,behavior:"smooth"})}}c.closest(".post-contents__mobile-bar")&&a.toggleMobileMenu()}),window.addEventListener("resize",function(){a.initSteps(),a.toggleItemsState(),a.initMobileBlock()}),window.addEventListener("scroll",function(){a.toggleItemsState()})}},{key:"initSteps",value:function(){var a=this;a.calcStepsPosition(a.contentsObj),a.calcStepsLength()}},{key:"calcStepsPosition",value:function(a,b){var c=this,d=Object.keys(a),e=document.querySelector(".article__content"),f=e.offsetTop+e.offsetHeight;d.forEach(function(e,g){var h=document.querySelector("[data-step-id=\"".concat(e,"\"]")),i=c.contentsBlock.querySelector("[data-contents-step-id=\"".concat(e,"\"]"));if(h){var j=h.offsetTop;if(c._steps[e]={name:a[e].name},c._steps[e].start=j,b&&(c._steps[e].isSubstep=!0),0<g){var k=d[g-1],l=c._steps[k];l.end=j,null!==c._lastSubstepId&&(c._steps[c._lastSubstepId].end=j,c._lastSubstepId=null)}g===d.length-1&&(c._steps[e].end=f,c._steps[e].isSubstep&&(c._lastSubstepId=e)),c._steps[e].contentsItem=i}if(a[e].substeps&&0<Object.keys(a[e].substeps).length){var m=a[e].substeps;c.calcStepsPosition(m,!0)}})}},{key:"calcStepsLength",value:function(){var a=this,b=Object.entries(a._steps);return 0!==b.length&&void b.forEach(function(b){var c=b[0],d=b[1],e=d.start,f=d.end;a._steps[c].percent=(f-e)/100})}},{key:"toggleItemsState",value:function(){var a=this,b=Object.entries(a._steps);if(0===b.length)return!1;var c=document.documentElement.clientHeight,d=window.pageYOffset+.5*c;b.forEach(function(b){var c=b[0],e=b[1],f=e.start,g=e.end,h=e.contentsItem;h.classList.toggle("post-contents__item_active",d>=f),d>=f&&d<=g&&!e.isSubstep&&(a._currentStep=c),a.changeProgressBar(c,e,d)})}},{key:"changeProgressBar",value:function(a,b,c){var d=this,e=b.start,f=b.end,g=b.percent,h=b.contentsItem,i=h.querySelector("[data-progress-step-id=\"".concat(a,"\"]"));if(901>=window.innerWidth&&d.contentsBlock.querySelector(".post-contents__mobile-bar")&&(i=d.contentsBlock.querySelector(".post-contents__progress_mobile[data-progress-step-id=\"".concat(a,"\"]"))),!i)return!1;var j=i.querySelector(".post-contents__progress-bar"),k=Math.ceil((c-e)/g);c>=f&&(k=100),j.style.width="".concat(k,"%")}},{key:"initMobileBlock",value:function(){var a=this,b=a.contentsBlock.parentElement;if(901>=window.innerWidth){var c=a.contentsBlock.clientHeight,d=window.pageYOffset+a.contentsBlock.getBoundingClientRect().top,e=d+c;a.toggleMobileBlock(e,b,c),window.addEventListener("scroll",function(){a.toggleMobileMenu(!1),a.toggleMobileBlock(e,b,c)})}else b.style.paddingTop=0,a.contentsBlock.classList.remove("post-contents_fixed")}},{key:"toggleMobileBlock",value:function(a,b,c){var d=this,e=window.pageYOffset>a,f=d.contentsBlock.querySelector(".post-contents__mobile-bar");if(e&&null!==d._currentStep){if(!f){var g=document.createElement("div");g.innerHTML=d._mobileBlockHtml,f=g.querySelector(".post-contents__mobile-bar"),d.contentsBlock.prepend(f)}var h=d._steps[d._currentStep];f.querySelector(".post-contents__mobile-active-step").innerText=h.name,f.querySelector(".post-contents__progress").setAttribute("data-progress-step-id",d._currentStep),d.toggleItemsState()}else f&&f.remove();b.style.paddingTop="".concat(e?c:0,"px"),d.toggleFixedMenu(!e),d.contentsBlock.classList.toggle("post-contents_fixed",e)}},{key:"toggleMobileMenu",value:function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:void 0,b=this,c=b.contentsBlock.querySelector(".post-contents__mobile-bar");if(c){c.classList.toggle("post-contents__mobile-bar_active",a);var d=c.classList.contains("post-contents__mobile-bar_active");b.toggleFixedMenu(d,d)}}},{key:"toggleFixedMenu",value:function(){var a=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],b=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],c=this,d=c.contentsBlock.querySelector(".post-contents__list_root");document.body.style.overflowY=b?"hidden":"auto",d.style.display=a?"block":"none"}},{key:"createContentsBlock",value:function(a){var b=document.querySelector(".article__sidebar");if(b){function o(a,b){var c=document.createElement("span");c.classList.add("post-contents__item-name");var d="<span class=\"post-contents__progress\" data-progress-step-id=\"".concat(a,"\"><span class=\"post-contents__progress-bar\"></span></span>");return c.innerHTML="".concat(b).concat(d),c}var c=document.createElement("div");c.classList.add("post-contents");var d=document.createElement("div");d.classList.add("post-contents__title"),d.innerText="Contents",c.appendChild(d);var e=document.createElement("ol");for(var f in e.classList.add("post-contents__list","post-contents__list_root","list","list_ordered"),a){var g=a[f],h=document.createElement("li");h.classList.add("post-contents__item"),h.setAttribute("data-contents-step-id",f);var i=o(f,g.name);if(h.appendChild(i),g.substeps){var j=document.createElement("ul");for(var k in j.classList.add("post-contents__list","list","list_marked"),g.substeps){var l=g.substeps[k],m=document.createElement("li");m.classList.add("post-contents__item","post-contents__item_sub"),m.setAttribute("data-contents-step-id",k);var n=o(k,l.name);m.appendChild(n),j.appendChild(m)}h.appendChild(j)}e.appendChild(h)}return c.appendChild(e),b.appendChild(c),c}}}]),a}();init();